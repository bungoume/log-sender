machine:
  services:
    - docker

dependencies:
  cache_directories:
    - "~/cache"
  override:
    - docker info
    - CIRCLE_BRANCH_HASH=`echo $CIRCLE_BRANCH | md5sum | cut -d' ' -f1`
    - if [[ -e ~/cahceh/image_$CIRCLE_BRANCH_HASH.tar ]]; then docker load -i ~/cache/image_$CIRCLE_BRANCH_HASH.tar; fi
    - docker build -t bungoume/log-sender .
    - mkdir -p ~/cache; docker save bungoume/log-sender > ~/cache/image_$CIRCLE_BRANCH_HASH.tar
    - find ~/cache -type f -mtime +1 -delete
    - docker run -d -p 10224:10224 -e TO_HOST=192.0.2.0 bungoume/log-sender

test:
  override:
    - nc -vz -w5 localhost 10224
